<form class="homey-form">
    <fieldset class="homey-form-fieldset">
        <legend class="homey-form-legend">Hvilket API vil du bruke?</legend>
        <div class="homey-form-group">
            <fieldset class="homey-form-radio-set">
                <legend class="homey-form-radio-set-title">Velg mellom lokal API og Cloud API
                </legend>
                <label class="homey-form-radio">
                    <input class="homey-form-radio-input" type="radio" name="selectAPI" value="cloud" />
                    <span class="homey-form-radio-checkmark"></span>
                    <span class="homey-form-radio-text">Cloud API</span>
                </label>
                <label class="homey-form-radio">
                    <input class="homey-form-radio-input" type="radio" name="selectAPI" value="local" />
                    <span class="homey-form-radio-checkmark"></span>
                    <span class="homey-form-radio-text">Lokal API (Kun Gen 3 enheter)</span>
                </label>
            </fieldset>
        </div>
    </fieldset>
</form>
<form class="homey-form" id="localAPIForm" style="display: none; margin-top: 50px;">
    <fieldset class="homey-form-fieldset">
        <legend class="homey-form-legend">Skriv inn IP-adresse til Mill-ovnen for lokal API</legend>
        <div class="homey-form-group">
            <label class="homey-form-label" for="target">IP-adresse</label>
            <input class="homey-form-input" id="target" type="text" value="" />
            <p style="margin-top: 5px;"><b style="color: red;">MERK! </b>Du bør sette fast IP til Mill-ovnene dine hvis
                du skal bruke lokalt API, for å slippe å måtte legge inn ovnene på nytt.</p>
        </div>
        <div class="homey-form-group">
            <button class="homey-button-primary-full" id="testConnection">Test tilkobling</button>
        </div>
    </fieldset>
    <fieldset class="homey-form-fieldset">
        <legend class="homey-form-legend">Autoscan</legend>
        <div class="homey-form-group">
            <label class="homey-form-label" for="gateway">Gateway adresse <small style="color: red;">(Ofte
                    <b>192.168.xxx.xxx</b> eller <b>10.xxx.xxx.xxx</b>)</small></label>
            <input class="homey-form-input" id="gateway" type="text" value="" />
            <p style="margin-top: 5px;">Autoscan vil automatisk legge til alle Mill-enheter som er tilkoblet samme
                nettverk som Homey. Dette er kun mulig med lokalt API. (Dette kan ta en stund. Vær tålmodig, og ikke lukk paringsvinduet før autoscan er ferdig.)</p>
            <div class="homey-form-group">
                <button class="homey-button-primary-full" id="autoscan">Autoscan</button>
            </div>
        </div>
    </fieldset>
    <fieldset class="homey-form-fieldset" id="errorField" style="display: none;">
        <p id="conFailed" style="display: none;">Tilkobling feilet. Sjekk IP-adressen og prøv igjen.</p>
        <p id="cloudError" style="display: none;">Tilkobling vellykket!</p>
    </fieldset>
</form>
<button class="homey-button-primary-full" id="nextButton" style="display: none; margin-top: 25px;">Neste</button>
<script type="application/javascript">
    Homey.setTitle(Homey.__("Mill Heating"));

    $('input[type=radio][name=selectAPI]').change(function () {
        $('#errorField').hide();
        $('#conFailed').hide();
        $('#cloudError').hide();

        if (this.value == 'cloud') {
            $('#localAPIForm').hide();
            $('#nextButton').show();
        } else if (this.value == 'local') {
            $('#localAPIForm').show();
            $('#nextButton').hide();
        }
    });

    $('#testConnection').on('click', function (e) {
        e.preventDefault();
        $('#errorField').hide();
        $('#conFailed').hide();
        $('#cloudError').hide();

        console.log("Testing connection to " + $('#target').val());
        Homey.emit('pingLocalDevice', $('#target').val()).then(function (result) {
            //console.log(result);
            if (result.error) {
                console.log("Connection failed.");
                $('#cloudError').hide();
                $('#errorField').show();
                $('#conFailed').show();
                return Homey.alert("Tilkobling feilet. Sjekk IP-adressen og prøv igjen.");
            } else {
                console.log("Connection successful.");
                //Homey.alert("Tilkobling vellykket!");
                return Homey.nextView();
            }
        });
    });

    $('#autoscan').on('click', function (e) {
            e.preventDefault();
            Homey.showLoadingOverlay();
            Homey.emit('autoscan', $('#gateway').val()).then(async function (result) {
                //console.log(result);
                if (result.error) {
                    console.log("Connection failed.");
                    await Homey.hideLoadingOverlay();
                    $('#cloudError').hide();
                    $('#errorField').show();
                    $('#conFailed').show();
                    return Homey.alert("Autoscan feilet. Sjekk at du har lagt til enheter i Mill-appen.");
                } else {
                    console.log("Connection successful.");
                    await Homey.hideLoadingOverlay();
                    //Homey.alert("Tilkobling vellykket!");
                    return Homey.nextView();
                }
            });
        });

    $('#nextButton').on('click', function (e) {
        e.preventDefault();
        Homey.emit('getCloudDevices').then(async function (result) {
            console.log(result);
            if (result.error) {
                await getCloudDevices();
            } else {
                return Homey.nextView();
            }
        });
    });

    async function getCloudDevices() {
        return new Promise((resolve, reject) => {
            Homey.emit('getIndependentCloudDevices').then(function (response) {
                console.log(response);
                if (response.error) {
                    Homey.setNavigationClose();
                    $('#errorField').show();
                    $('#cloudError').show();
                    $('#conFailed').hide();
                    return Homey.alert("Fant ingen Mill-enheter i Cloud API. Sjekk at du har lagt til enheter i Mill-appen.");
                } else {
                    return Homey.nextView();
                }
            });
        });
    }
</script>